<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grafo de Colaborações</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .center{
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .keyword-svg {
            display: block;
            margin: auto;
            background: #f9f9f9;
        }
    </style>
</head>

<body>
    <h2 class="text-center mt-3">Grafo de Colaborações</h2>
    <div class="row ms center mb-4" >
        <div class="col-4">
            <input type="text" id="searchInput" class="form-control" placeholder="Digite o nome do autor">
        </div>
        <div class="col-1">
            <button onclick="filterGraph()" class="btn text-white" style="background-color: #774ce4;">Buscar</button>
        </div>
    </div>
    <div class="row mx-3">
        <div id="graph_autor" class="col-7 border border-dark border-1 " style="border-radius: 20px;"></div>
        <div id="graph_keyword" class="col-4 border border-1 border-dark ms-3" style="border-radius: 20px;"></div>
    </div>
    
    <script>
        let fullGraphData;
        let articleData;

        d3.json("grafo_autores.json").then(function (graph) {
            fullGraphData = graph;
            d3.json("autores_artigos.json").then(function (artigos) {
                articleData = artigos;
                renderGraph(graph);
            });
        });

        function renderGraph(graph) {
            d3.select("#graph_autor").selectAll("*").remove();

            const width = 720;
            const height = 600;

            const svg = d3.select("#graph_autor").append("svg")
                .attr("width", width)
                .attr("height", height);

            const simulation = d3.forceSimulation(graph.nodes)
                .force("link", d3.forceLink(graph.links).id(d => d.id).distance(180))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2));

            const node = svg.selectAll(".node")
                .data(graph.nodes)
                .enter().append("circle")
                .attr("class", "node")
                .attr("r", 12)
                .attr("fill", "#774CE4")
                .call(d3.drag()
                    .on("start", dragStart)
                    .on("drag", dragged)
                    .on("end", dragEnd));

            simulation.on("tick", () => {
                node.attr("cx", d => d.x).attr("cy", d => d.y);
            });
        }

        function filterGraph() {
            const selectedAuthor = document.getElementById("searchInput").value;
            if (!selectedAuthor) {
                alert("Por favor, digite um nome válido.");
                return;
            }

            const filteredNodes = fullGraphData.nodes.filter(node =>
                node.id === selectedAuthor ||
                fullGraphData.links.some(link => (link.source.id === selectedAuthor && link.target.id === node.id) || (link.target.id === selectedAuthor && link.source.id === node.id))
            );

            const filteredLinks = fullGraphData.links.filter(link =>
                link.source.id === selectedAuthor || link.target.id === selectedAuthor ||
                (filteredNodes.some(node => node.id === link.source.id) && filteredNodes.some(node => node.id === link.target.id))
            );

            const filteredGraph = {
                nodes: filteredNodes,
                links: filteredLinks
            };

            renderGraph(filteredGraph);
            renderCirclePacking(selectedAuthor);
        }

        function renderCirclePacking(author) {
            d3.select("#graph_keyword").selectAll("*").remove();

            const width = 400, height = 400;

            const svg = d3.select("#graph_keyword").append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("class", "keyword-svg");

            const authorData = articleData.find(a => a.author === author);
            if (!authorData) return;

            let keywordCounts = {};
            authorData.articles.forEach(article => {
                article.keywords.forEach(keyword => {
                    keywordCounts[keyword] = (keywordCounts[keyword] || 0) + 1;
                });
            });

            const data = {
                name: "root",
                children: Object.keys(keywordCounts).map(keyword => ({ name: keyword, value: keywordCounts[keyword] }))
            };

            const pack = d3.pack()
                .size([width, height])
                .padding(10);

            const root = d3.hierarchy(data)
                .sum(d => d.value);

            const nodes = pack(root).descendants();

            svg.selectAll("circle")
                .data(nodes)
                .enter().append("circle")
                .attr("cx", d => d.x)
                .attr("cy", d => d.y)
                .attr("r", d => d.r)
                .attr("fill", (d, i) => d.children ? "#ccc" : "#774CE4")
                .attr("stroke", "#333");

            svg.selectAll("text")
                .data(nodes.filter(d => !d.children))
                .enter().append("text")
                .attr("x", d => d.x)
                .attr("y", d => d.y)
                .attr("dy", "0.3em")
                .attr("text-anchor", "middle")
                .style("fill", "white")
                .style("font-size", "12px")
                .text(d => d.data.name);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>

</html>
